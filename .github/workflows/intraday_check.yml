name: intraday-check

on:
  workflow_dispatch:
    inputs:
      loops:
        description: '循环次数(每次2分钟)'
        required: false
        default: '30'
  schedule:
    # 工作日午盘例：01:30 UTC 开始(= 09:30 北京时间)，根据需要自行调整
    - cron: "30 1 * * 1-5"

jobs:
  run-check:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      TZ: Asia/Shanghai

      # ====== 监控清单 ======
      FUND_CODES: "022364,006502,018956"
      ETF_CODES:  "512810,513530,159399"

      # ====== 价格/量能参数 ======
      PULLBACK_MIN: "0.05"      # ETF 波段：回撤下限 5%
      PULLBACK_MAX: "0.08"      # ETF 波段：回撤上限 8%
      VOL_BREAKOUT: "1.8"       # 放量突破阈值：当前分钟推算 > 1.8 × 均量

      # ====== 资金管理 ======
      TOTAL_ASSETS: ""          # 为空时脚本默认 100000
      ATTACK_PCT_FUNDS: "0.10"  # 场外基金进攻仓：单只占总资产 10%
      ATTACK_PCT_ETF_MIN: "0.03"
      ATTACK_PCT_ETF_MAX: "0.04"

      # ====== 通知通道（Server酱 Turbo）======
      SCT_KEY: ""               # 例如：SCUxxxxxxx（留空则仅打印日志）

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests pandas pytz

      - name: Intraday loop (2 min)
        env:
          LOOPS: ${{ github.event.inputs.loops }}
        run: |
          set -e
          LOOPS=${LOOPS:-30}
          echo "Start intraday loop at: $(date -u '+%Y-%m-%d %T') UTC"
          i=1
          while [ $i -le $LOOPS ]; do
            echo "== iteration $i =="
            python check_once.py || true
            sleep 120
            i=$((i+1))
          done
